<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo de Filmes e Séries</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <style>
        :root {
            --amoled-black: #000000;
            --purple-accent: #593BA2;
            --purple-light: #8c70c8;
            --text-primary: #F3F4F6;
            --text-secondary: #9CA3AF;
            --card-bg: #0F071A;
            --border-color: #251A3D;
            --border-highlight: #3A2B5C;
            --danger-red: #E53E3E;
            --danger-red-hover: #C53030;
            --success-green: #48BB78;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--amoled-black);
            color: var(--text-primary);
            transition: background-image 0.5s ease-in-out;
        }

        body.swal2-shown:not(.swal2-no-backdrop):not(.swal2-toast-shown) {
             overflow: hidden !important;
        }

        #pageBackdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            transition: background-image 0.7s ease-in-out, opacity 0.7s ease-in-out;
            background-color: var(--amoled-black);
            opacity: 0;
        }

        #pageBackdrop::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: -1;
        }

        .content-section {
            margin-bottom: 2.5rem;
        }

        /* horizontal-scroll-grid is responsive via CSS media queries directly */
        .horizontal-scroll-grid {
            display: flex; /* Default for mobile-first: enables horizontal scrolling */
            overflow-x: auto;
            white-space: nowrap; /* Prevents items from wrapping in flex mode */
            padding-bottom: 1.25rem;
            gap: 1rem;
        }
        .horizontal-scroll-grid .content-card {
            flex: 0 0 calc(50% - 0.75rem); /* Two cards visible on smaller screens */
            max-width: 180px;
        }
        .horizontal-scroll-grid::-webkit-scrollbar {
            height: 7px;
        }
        .horizontal-scroll-grid::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 10px;
        }
        .horizontal-scroll-grid::-webkit-scrollbar-thumb {
            background-color: var(--purple-accent);
            border-radius: 10px;
        }

        .main-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
            gap: 1.5rem;
        }

        .content-card {
            background-color: var(--card-bg);
            border-radius: 0.75rem;
            overflow: hidden;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            cursor: pointer;
            border: 1px solid var(--border-color);
            box-shadow: 0 6px 12px -3px rgba(0,0,0,0.35);
            position: relative;
        }
        .content-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 12px 24px -6px rgba(89, 59, 162, 0.4);
            border-color: var(--border-highlight);
        }
        .content-card img {
            width: 100%;
            height: auto;
            aspect-ratio: 2/3;
            object-fit: cover;
            display: block;
        }
        .content-card .title-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(10, 5, 20, 0.9) 20%, rgba(10, 5, 20, 0));
            padding: 1.5rem 0.75rem 0.75rem 0.75rem;
        }
        .content-card .title {
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary);
            line-height: 1.3;
            max-height: 3.9em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        /* SweetAlert2 General Customizations */
        .swal2-popup {
            background-color: var(--card-bg) !important;
            color: var(--text-primary) !important;
            border-radius: 1rem !important;
            border: 1px solid var(--border-color) !important;
            max-width: 90% !important;
        }
        .swal2-title {
            color: var(--purple-light) !important;
            font-size: 1.5rem !important;
            padding-top: 1.5rem !important;
            margin-bottom: 0 !important;
        }
        .swal2-html-container {
            color: var(--text-primary) !important;
            margin: 0.5em 1em 0.3em !important;
            text-align: left !important;
        }
        .swal2-close {
            color: #FFFFFF !important;
            font-size: 2em !important;
            transition: color 0.2s ease, transform 0.2s ease !important;
            position: absolute !important;
            top: 12px !important;
            right: 15px !important;
            z-index: 100;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
        }
        .swal2-close:hover {
            color: var(--purple-light) !important;
            transform: scale(1.1) !important;
        }

        /* SweetAlert2 Filter-Specific Styles */
        .swal-genre-filter-type-selector button,
        .swal-genre-buttons-panel button,
        .swal-filter-actions button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid var(--border-highlight);
            background-color: var(--card-bg);
            color: var(--text-secondary);
            transition: all 0.2s ease;
            margin: 0.25rem;
        }
        .swal-genre-filter-type-selector button.active,
        .swal-genre-buttons-panel button.active {
            background-color: var(--purple-accent);
            color: var(--amoled-black);
            border-color: var(--purple-accent);
            box-shadow: 0 0 10px rgba(89, 59, 162, 0.4);
        }
        .swal-filter-actions .swal2-confirm {
            background-color: var(--purple-accent) !important;
            color: var(--amoled-black) !important;
            border: 1px solid var(--purple-accent) !important;
        }
        .swal-filter-actions .swal2-confirm:hover {
            background-color: var(--purple-light) !important;
            border-color: var(--purple-light) !important;
        }
        .swal-filter-actions .swal2-deny {
            background-color: var(--danger-red) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--danger-red) !important;
        }
        .swal-filter-actions .swal2-deny:hover {
            background-color: var(--danger-red-hover) !important;
            border-color: var(--danger-red-hover) !important;
        }
        .swal-genre-buttons-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 0.6rem;
            justify-content: center;
            max-height: 180px;
            overflow-y: auto;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.6rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
        }
        .swal-genre-buttons-panel::-webkit-scrollbar { width: 5px; }
        .swal-genre-buttons-panel::-webkit-scrollbar-track { background: var(--card-bg); border-radius: 0.6rem; }
        .swal-genre-buttons-panel::-webkit-scrollbar-thumb { background-color: var(--purple-accent); border-radius: 8px; }

        /* SweetAlert2 Item Details Modal Specific Styles */
        .swal-details-popup.swal2-popup {
            width: 850px !important;
            max-width: 95vw !important;
            max-height: 90vh !important;
            display: flex !important;
            flex-direction: column !important;
        }
        .swal-details-popup .swal2-html-container {
            overflow-y: auto !important;
            flex-grow: 1 !important;
            padding: 0.5em 1em;
            scrollbar-width: thin;
            scrollbar-color: var(--purple-accent) var(--border-color);
        }
        .swal-details-popup .swal2-html-container::-webkit-scrollbar {
            width: 8px;
        }
        .swal-details-popup .swal2-html-container::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 10px;
        }
        .swal-details-popup .swal2-html-container::-webkit-scrollbar-thumb {
            background-color: var(--purple-accent);
            border-radius: 10px;
        }

        .swal-details-content {
             padding-bottom: 1rem;
        }

        .swal-details-content .details-flex-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .swal-details-content .details-poster {
            width: 100%;
            max-width: 250px;
            height: auto;
            object-fit: contain;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            align-self: center;
        }
        .swal-details-content .details-info-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .swal-details-content .details-content-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--purple-light);
            line-height: 1.2;
            margin-bottom: 0.5rem;
        }
        .swal-details-content .details-meta-info {
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.75rem 0.75rem;
        }
        .swal-details-content .details-meta-info span {
            display: inline-flex;
            align-items: center;
        }
        .swal-details-content .details-meta-info .fas {
            margin-right: 0.375rem;
        }
        .swal-details-content .details-genres {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .swal-details-content .details-genres strong {
            color: var(--purple-light);
            font-size: 0.95rem;
        }
        .swal-details-content .details-section-subtitle {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--purple-light);
            margin-top: 0.75rem;
            margin-bottom: 0.5rem;
        }
        .swal-details-content .details-overview {
            font-size: 0.95rem;
            line-height: 1.65;
            color: var(--text-primary);
        }
        .swal-details-content .details-actions {
            margin-top: 1rem;
            display: flex;
            justify-content: flex-start;
            gap: 0.75rem;
        }
        .swal-details-content .copy-link-button {
            background-color: var(--purple-accent);
            color: var(--amoled-black);
            border: 1px solid var(--purple-accent);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .swal-details-content .copy-link-button:hover {
            background-color: var(--purple-light);
            border-color: var(--purple-light);
        }
        .swal-details-content .copy-link-button .fas {
            margin-right: 0.5rem;
        }

        /* Cast Section Styles */
        .details-cast-section {
            margin-top: 1.5rem;
        }
        .details-cast-scroller {
            display: flex;
            overflow-x: auto;
            gap: 1rem;
            padding: 0.75rem 0.25rem;
            margin-bottom: 1rem;
        }
        .details-cast-scroller::-webkit-scrollbar {
            height: 6px;
        }
        .details-cast-scroller::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 10px;
        }
        .details-cast-scroller::-webkit-scrollbar-thumb {
            background-color: var(--purple-accent);
            border-radius: 10px;
        }
        .cast-member-card {
            flex: 0 0 100px;
            text-align: center;
            background-color: rgba(255,255,255,0.03);
            padding: 0.75rem 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .cast-member-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 0.5rem auto;
            border: 2px solid var(--border-highlight);
            background-color: var(--border-color);
        }
        .cast-member-name {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 0.25rem;
        }
        .cast-member-character {
            font-size: 0.7rem;
            color: var(--text-secondary);
            line-height: 1.2;
            height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* End Cast Section Styles */

        /* Player Section Styles */
        .details-player-section {
            margin-top: 1rem;
        }
        .details-iframe-container {
            margin-top: 0.5rem;
            background-color: #000;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            aspect-ratio: 16 / 9;
        }
        .details-iframe-container.iframe-series-dimensions {
            aspect-ratio: auto;
            height: 500px;
        }

        .details-iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .swal-details-content .details-player-unavailable {
            margin-top: 1.25rem;
            text-align: center;
            color: #FFD700;
            background-color: rgba(255, 215, 0, 0.15);
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
        }

        @media (min-width: 768px) {
            .swal-details-content .details-flex-container {
                flex-direction: row;
            }
            .swal-details-content .details-poster {
                align-self: flex-start;
            }
            .details-iframe-container.iframe-series-dimensions {
                 height: 520px;
            }
            /* CSS handles horizontal-scroll-grid responsiveness on desktop */
            .horizontal-scroll-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
                overflow-x: hidden; /* No horizontal scroll in grid mode */
                white-space: normal; /* Allow wrapping in grid mode */
                gap: 1.5rem; /* Consistent gap with main-results-grid */
            }
            .horizontal-scroll-grid .content-card {
                flex: none; /* Remove flex behavior */
                width: auto; /* Allow grid to control width */
                max-width: none; /* Allow grid to control width */
            }
        }
        /* End SweetAlert2 Item Details Styles */

        /* Filter Toggle Button in Header */
         #filterToggleButton {
            padding: 0.6rem 1.2rem;
            border-radius: 0.6rem;
            font-weight: 600;
            font-size: 0.9rem;
            border: 1px solid var(--border-highlight);
            background-color: var(--purple-accent);
            color: var(--amoled-black);
            transition: all 0.2s ease;
            margin-left: 0.5rem;
         }
         #filterToggleButton:hover {
             background-color: var(--purple-light);
             border-color: var(--purple-light);
         }
         #filterToggleButton.active {
            box-shadow: 0 0 10px rgba(89, 59, 162, 0.7);
            border-color: var(--purple-light);
         }
         #filterToggleButton:disabled {
            background-color: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            border-color: var(--border-color);
         }


        .loader {
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--purple-accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
            margin: 40px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-search-wrapper {
            position: relative;
            width: 100%;
            max-width: 400px;
            flex-grow: 1;
        }
        .input-search {
            background-color: var(--card-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            width: 100%;
            padding: 0.75rem 1.1rem;
            padding-right: 3.2rem;
            border-radius: 0.6rem;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-search:focus {
            outline: none;
            border-color: var(--purple-accent);
            box-shadow: 0 0 0 3px rgba(89, 59, 162, 0.3);
        }
        .input-search::placeholder {
            color: var(--text-secondary);
        }
        .input-search:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
        #searchButton {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            padding: 0 1.1rem;
            color: var(--text-secondary);
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: color 0.2s;
        }
        #searchButton:hover {
            color: var(--purple-accent);
        }
        #searchButton:disabled {
            color: var(--text-secondary);
            cursor: not-allowed;
        }


        header {
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 10px -3px rgba(0,0,0,0.6);
            padding: 1.1rem 1rem;
            position: sticky;
            top: 0;
            z-index: 900;
        }
        header h1 {
            color: var(--purple-light);
            font-weight: 700;
        }
        header h1 .fa-film {
            color: var(--purple-accent);
        }
        .header-controls {
            display: flex;
            align-items: center;
            width: 100%;
            gap: 0.5rem;
        }

        /* Media Queries para responsividade */
        @media (max-width: 767px) {
            .horizontal-scroll-grid .content-card {
                flex: 0 0 calc(48% - 0.5rem); /* Adjust for slightly more space or preference */
                max-width: 170px;
            }

            header .container {
                flex-direction: column;
                align-items: center;
            }
            .header-controls-wrapper {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }
             .header-controls {
                flex-direction: row;
                justify-content: center;
                width: 98%;
             }
             .input-search-wrapper {
                max-width: none;
                width: auto;
             }
            .section-title {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            .swal-details-popup.swal2-popup {
                 width: 95vw !important;
                 max-width: 95vw !important;
            }
            .swal-details-content .details-content-title {
                font-size: 1.5rem;
            }
            .details-iframe-container.iframe-series-dimensions {
                 height: 400px;
            }
            .cast-member-card {
                flex: 0 0 85px;
            }
            .cast-member-photo {
                width: 60px;
                height: 60px;
            }
        }

        @media (min-width: 768px) {
            .header-controls-wrapper {
                 width: auto;
            }
            .header-controls {
                 width: auto;
            }
            /* .horizontal-scroll-grid specific desktop styles are now above */
        }

        @media (min-width: 768px) and (max-width: 1023px) {
             .main-results-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
             }
        }

        @media (max-width: 480px) {
            .horizontal-scroll-grid .content-card {
                flex: 0 0 calc(48% - 0.4rem);
                max-width: 150px;
            }
            header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="pageBackdrop"></div>

    <header> <div class="container mx-auto flex flex-col lg:flex-row justify-between items-center space-y-4 lg:space-y-0 px-4 relative">
            <div class="header-controls-wrapper">
                <h1 class="text-3xl md:text-4xl font-bold text-center lg:text-left">Meu Catálogo <i class="fas fa-film"></i></h1>
                <div class="header-controls">
                    <div class="input-search-wrapper">
                        <input type="text" id="searchInput" placeholder="Buscar filmes ou séries..." class="input-search">
                        <button id="searchButton" aria-label="Buscar">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <button id="filterToggleButton" aria-label="Mostrar filtros">
                        Filtros
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div id="loader" class="loader" style="display: none;"></div>

    <main id="contentArea" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <div id="defaultContentSections">
            <div id="moviesSection" class="content-section">
                 <h2 class="text-xl md:text-2xl font-semibold mb-3 md:mb-4 section-title">Filmes Populares</h2>
                <div id="moviesResultsGrid" class="horizontal-scroll-grid"></div>
            </div>
            <div id="tvShowsSection" class="content-section">
                 <h2 class="text-xl md:text-2xl font-semibold mb-3 md:mb-4 section-title">Séries Populares</h2>
                <div id="tvShowsResultsGrid" class="horizontal-scroll-grid"></div>
            </div>
        </div>

        <div id="singleResultsSection" class="content-section" style="display: none;">
             <h2 id="singleSectionTitle" class="section-title text-xl md:text-2xl font-semibold mb-3 md:mb-4">Resultados</h2>
             <div id="singleResultsGrid" class="main-results-grid"></div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // --- Constants and Configuration ---
        const TMDB_API_KEY = '5e5da432e96174227b25086fe8637985'; // IMPORTANT: Replace with your actual TMDB API Key
        const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
        const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/';
        const TMDB_BACKDROP_BASE_URL = 'https://image.tmdb.org/t/p/original';
        const LANGUAGE = 'pt-BR';
        const PLACEHOLDER_PERSON_IMAGE = 'https://placehold.co/185x278/0F071A/F3F4F6?text=Sem+Foto&font=inter';
        const PLAYER_BASE_URL_MOVIE = 'https://superflixapi.ist/filme/'; // External player URL for movies
        const PLAYER_BASE_URL_SERIES = 'https://superflixapi.ist/serie/'; // External player URL for series

        // --- DOM Element References ---
        const pageBackdrop = document.getElementById('pageBackdrop');
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const filterToggleButton = document.getElementById('filterToggleButton');
        const defaultContentSections = document.getElementById('defaultContentSections');
        const moviesResultsGrid = document.getElementById('moviesResultsGrid');
        const tvShowsResultsGrid = document.getElementById('tvShowsResultsGrid');
        const singleResultsSection = document.getElementById('singleResultsSection');
        const singleSectionTitleEl = document.getElementById('singleSectionTitle');
        const singleResultsGrid = document.getElementById('singleResultsGrid');
        const loader = document.getElementById('loader');

        // --- State Variables ---
        let currentFilterTypeSA = 'movie'; // Type ('movie'/'tv') selected in SweetAlert filter modal
        let selectedGenreSA = { id: null, name: null, type: null }; // Genre selected in SweetAlert filter modal
        let activeAppliedGenre = { id: null, name: null, type: null }; // Currently active genre filter
        let searchTimeout = null; // For debouncing search input
        let currentOpenSwalRef = null; // Reference to the currently open SweetAlert instance

        // --- API Functions ---
        async function fetchTMDB(endpoint, params = {}) {
            const urlParams = new URLSearchParams({ api_key: TMDB_API_KEY, language: LANGUAGE, include_adult: 'false', ...params });
            const url = `${TMDB_BASE_URL}${endpoint}?${urlParams}`;
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ status_message: response.statusText, success: false }));
                    console.error(`TMDB API Error: ${response.status} ${response.statusText}`, errorData);
                    // Return a more structured error or null to indicate failure
                    return { error: true, status: response.status, message: errorData.status_message || "Unknown API error" };
                }
                return await response.json();
            } catch (error) {
                console.error('Network Error fetching TMDB data:', error);
                return { error: true, message: "Network error, please check your connection." };
            }
        }

        // --- Core Application Logic ---
        async function loadMainPageContent() {
            console.log("loadMainPageContent called");
            showLoader();
            defaultContentSections.style.display = 'block';
            singleResultsSection.style.display = 'none';
            filterToggleButton.classList.remove('active');
            activeAppliedGenre = { id: null, name: null, type: null };

            const moviesPromise = fetchTMDB(`/movie/popular`);
            const tvShowsPromise = fetchTMDB(`/tv/top_rated`); 

            const [moviesData, tvShowsData] = await Promise.all([moviesPromise, tvShowsPromise]);

            if (moviesData && !moviesData.error && moviesData.results) {
                displayResults(moviesData.results, 'movie', moviesResultsGrid);
            } else {
                moviesResultsGrid.innerHTML = `<p class="text-center col-span-full text-[var(--text-secondary)] py-5">Não foi possível carregar filmes populares. ${moviesData?.message || ''}</p>`;
            }
            if (tvShowsData && !tvShowsData.error && tvShowsData.results) {
                displayResults(tvShowsData.results, 'tv', tvShowsResultsGrid);
            } else {
                tvShowsResultsGrid.innerHTML = `<p class="text-center col-span-full text-[var(--text-secondary)] py-5">Não foi possível carregar séries populares. ${tvShowsData?.message || ''}</p>`;
            }
            hideLoader();
        }

        async function performSearch(query) {
            console.log("performSearch called with query:", query);
            showLoader();
            activeAppliedGenre = { id: null, name: null, type: null };
            selectedGenreSA = { id: null, name: null, type: null };
            filterToggleButton.classList.remove('active');

            if (!query.trim()) {
                loadMainPageContent(); 
                return;
            }

            defaultContentSections.style.display = 'none';
            singleResultsSection.style.display = 'block';
            singleSectionTitleEl.textContent = `Resultados para: "${query}"`;

            const data = await fetchTMDB('/search/multi', { query: query });
            if (data && !data.error && data.results) {
                const filteredResults = data.results.filter(item => (item.media_type === 'movie' || item.media_type === 'tv') && item.poster_path);
                if (filteredResults.length > 0) {
                    displayResults(filteredResults, null, singleResultsGrid);
                } else {
                    singleResultsGrid.innerHTML = `<p class="text-center col-span-full">Nenhum filme ou série relevante encontrado para "${query}".</p>`;
                }
            } else {
                 singleResultsGrid.innerHTML = `<p class="text-center col-span-full">Não foi possível realizar a busca. ${data?.message || 'Tente novamente.'}</p>`;
            }
            hideLoader();
        }

        // --- Filter Logic (SweetAlert2) ---
        async function openFilterSweetAlert() {
            console.log("openFilterSweetAlert called");
            const swalHTML = `
                <div class="swal-genre-filter-type-selector mb-4">
                    <button id="swalMovieGenreTypeButton" data-type="movie" class="${currentFilterTypeSA === 'movie' ? 'active' : ''}">Filmes</button>
                    <button id="swalTvGenreTypeButton" data-type="tv" class="${currentFilterTypeSA === 'tv' ? 'active' : ''}">Séries</button>
                </div>
                <div id="swalGenreButtonsPanel" class="swal-genre-buttons-panel my-4">
                    Carregando gêneros...
                </div>
            `;

            currentOpenSwalRef = Swal.fire({
                title: 'Filtrar por Gênero',
                html: swalHTML,
                showCloseButton: true,
                showCancelButton: false,
                showDenyButton: true, 
                denyButtonText: 'Limpar Filtro',
                confirmButtonText: 'Aplicar Filtro',
                customClass: {
                    popup: 'swal2-popup',
                    title: 'swal2-title',
                    htmlContainer: 'swal2-html-container',
                    closeButton: 'swal2-close',
                    actions: 'swal-filter-actions',
                    confirmButton: 'swal2-confirm',
                    denyButton: 'swal2-deny'
                },
                didOpen: () => {
                    const movieBtn = document.getElementById('swalMovieGenreTypeButton');
                    const tvBtn = document.getElementById('swalTvGenreTypeButton');
                    const genrePanel = document.getElementById('swalGenreButtonsPanel');

                    movieBtn.addEventListener('click', () => fetchAndDisplayGenresInSA('movie', genrePanel));
                    tvBtn.addEventListener('click', () => fetchAndDisplayGenresInSA('tv', genrePanel));

                    fetchAndDisplayGenresInSA(currentFilterTypeSA, genrePanel); 
                    updateClearButtonVisibilitySA();
                },
                preConfirm: () => {
                    return selectedGenreSA; 
                },
            });

            currentOpenSwalRef.then(async (result) => {
                if (result.isConfirmed) {
                    if (selectedGenreSA.id) { 
                        await applyGenreFilterFromSA();
                    } else { 
                        activeAppliedGenre = { id: null, name: null, type: null };
                        filterToggleButton.classList.remove('active');
                        loadMainPageContent(); 
                    }
                } else if (result.isDenied) { 
                    selectedGenreSA = { id: null, name: null, type: null };
                    activeAppliedGenre = { id: null, name: null, type: null };
                    filterToggleButton.classList.remove('active');
                    loadMainPageContent(); 
                }
                currentOpenSwalRef = null; 
            });
        }

        async function fetchAndDisplayGenresInSA(mediaType, genrePanelElement) {
            currentFilterTypeSA = mediaType;
            const movieBtn = document.getElementById('swalMovieGenreTypeButton');
            const tvBtn = document.getElementById('swalTvGenreTypeButton');
            if (movieBtn) movieBtn.classList.toggle('active', mediaType === 'movie');
            if (tvBtn) tvBtn.classList.toggle('active', mediaType === 'tv');

            if (selectedGenreSA.id && mediaType !== selectedGenreSA.type) {
                 selectedGenreSA = { id: null, name: null, type: null };
            }

            genrePanelElement.innerHTML = '<div class="loader mx-auto my-3" style="width: 30px; height: 30px; border-width: 3px;"></div>';
            const data = await fetchTMDB(`/genre/${mediaType}/list`);
            genrePanelElement.innerHTML = ''; 
            if (data && !data.error && data.genres) {
                data.genres.forEach(genre => {
                    const button = document.createElement('button');
                    button.textContent = genre.name;
                    button.dataset.genreId = genre.id;
                    button.dataset.genreName = genre.name;
                    
                    if (genre.id === selectedGenreSA.id && mediaType === selectedGenreSA.type) {
                        button.classList.add('active');
                    }
                    button.onclick = () => {
                        if (selectedGenreSA.id === genre.id && selectedGenreSA.type === mediaType) {
                            selectedGenreSA = { id: null, name: null, type: null };
                        } else {
                            selectedGenreSA = { id: genre.id, name: genre.name, type: mediaType };
                        }
                        updateGenreButtonsInSAUI(genrePanelElement);
                        updateClearButtonVisibilitySA();
                    };
                    genrePanelElement.appendChild(button);
                });
            } else {
                genrePanelElement.innerHTML = `<p class="text-xs text-center">Gêneros não encontrados. ${data?.message || ''}</p>`;
            }
            updateGenreButtonsInSAUI(genrePanelElement); 
            updateClearButtonVisibilitySA();
        }

        function updateGenreButtonsInSAUI(genrePanelElement) {
            if (!genrePanelElement) return;
            const buttons = genrePanelElement.querySelectorAll('button');
            buttons.forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.genreId) === selectedGenreSA.id && currentFilterTypeSA === selectedGenreSA.type);
            });
        }

        function updateClearButtonVisibilitySA() {
            const denyButton = Swal.getDenyButton();
            if (denyButton) {
                denyButton.style.display = (selectedGenreSA.id || activeAppliedGenre.id) ? 'inline-flex' : 'none';
            }
        }

        async function applyGenreFilterFromSA() {
            console.log("applyGenreFilterFromSA called with:", selectedGenreSA);
            if (!selectedGenreSA.id) { 
                activeAppliedGenre = { id: null, name: null, type: null };
                filterToggleButton.classList.remove('active');
                loadMainPageContent();
                return;
            }
            showLoader();
            activeAppliedGenre = { ...selectedGenreSA }; 

            defaultContentSections.style.display = 'none';
            singleResultsSection.style.display = 'block';
            singleSectionTitleEl.textContent = `${activeAppliedGenre.type === 'movie' ? 'Filmes' : 'Séries'} do Gênero: ${activeAppliedGenre.name}`;

            const data = await fetchTMDB(`/discover/${activeAppliedGenre.type}`, { with_genres: activeAppliedGenre.id, sort_by: 'popularity.desc' });
            if (data && !data.error && data.results) {
                if (data.results.length > 0) {
                    displayResults(data.results, activeAppliedGenre.type, singleResultsGrid);
                } else {
                    singleResultsGrid.innerHTML = `<p class="text-center col-span-full">Nenhum item encontrado para o gênero ${activeAppliedGenre.name}.</p>`;
                }
            } else {
                singleResultsGrid.innerHTML = `<p class="text-center col-span-full">Não foi possível aplicar o filtro. ${data?.message || 'Tente novamente.'}</p>`;
            }
            hideLoader();
            filterToggleButton.classList.add('active'); 
        }

        // --- Item Details Modal ---
        async function getItemDetails(itemId, mediaType) {
            const data = await fetchTMDB(`/${mediaType}/${itemId}`, { append_to_response: 'external_ids,credits,videos' });
            return data; 
        }

        function showLoader() {
            loader.style.display = 'block';
            // Do not hide main sections here, let the calling function decide
        }

        function hideLoader() {
            loader.style.display = 'none';
        }

        function updatePageBackground(backdropPath) {
            if (backdropPath) {
                pageBackdrop.style.backgroundImage = `url(${TMDB_BACKDROP_BASE_URL}${backdropPath})`;
                pageBackdrop.style.opacity = '1';
            } else {
                pageBackdrop.style.opacity = '0';
                setTimeout(() => {
                    if (pageBackdrop.style.opacity === '0') { 
                        pageBackdrop.style.backgroundImage = '';
                    }
                }, 700); 
            }
        }

        function displayResults(items, defaultMediaType = null, targetGridElement) {
            targetGridElement.innerHTML = ''; 
            if (!items || items.length === 0) {
                targetGridElement.innerHTML = `<p class="text-center col-span-full text-[var(--text-secondary)] py-10 text-lg">Nenhum item para exibir.</p>`;
                return;
            }

            items.forEach(item => {
                const mediaType = item.media_type || defaultMediaType;
                if (!mediaType || (mediaType !== 'movie' && mediaType !== 'tv') || !item.poster_path) return;

                const card = document.createElement('div');
                card.className = 'content-card shadow-lg group';
                card.onclick = () => openItemModal(item.id, mediaType, item.backdrop_path);
                card.setAttribute('role', 'button');
                card.setAttribute('tabindex', '0');
                card.setAttribute('aria-label', `Ver detalhes de ${item.title || item.name}`);

                const img = document.createElement('img');
                img.src = `${TMDB_IMAGE_BASE_URL}w780${item.poster_path}`;
                img.alt = `Pôster de ${item.title || item.name}`;
                img.loading = 'lazy'; 
                img.onerror = () => { 
                    img.src = `https://placehold.co/780x1170/0A0514/F0F0F0?text=Indispon%C3%ADvel&font=inter`;
                    img.alt = 'Imagem indisponível';
                };
                
                const titleOverlay = document.createElement('div');
                titleOverlay.className = 'title-overlay';
                
                const titleDiv = document.createElement('div');
                titleDiv.className = 'title';
                titleDiv.textContent = item.title || item.name;

                titleOverlay.appendChild(titleDiv);
                card.appendChild(img);
                card.appendChild(titleOverlay);
                targetGridElement.appendChild(card);
            });
        }

        function copyToClipboard(textToCopy, isContentLink = false) {
            const linkType = isContentLink ? "da página" : "do player";
            const warningTitle = isContentLink ? `Nenhum link ${linkType} disponível para copiar.` : `Nenhum link ${linkType} disponível para copiar.`;
            const successTitle = `Link ${linkType} copiado!`;
            const errorTitle = `Falha ao copiar link ${linkType}!`;

            if (!textToCopy) { 
                 Swal.fire({ toast: true, position: 'top-end', icon: 'warning', title: warningTitle, showConfirmButton: false, timer: 2500, background: 'var(--card-bg)', color: 'var(--text-primary)', iconColor: 'var(--text-secondary)'});
                return;
            }
            const tempTextArea = document.createElement("textarea");
            tempTextArea.value = textToCopy;
            tempTextArea.style.position = "absolute"; tempTextArea.style.left = "-9999px"; 
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            tempTextArea.setSelectionRange(0, 99999); 

            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                console.warn('Fallback: document.execCommand copy failed', err);
            }
            document.body.removeChild(tempTextArea);

            const swalProps = { toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, background: 'var(--card-bg)', color: 'var(--text-primary)', timerProgressBar: true };

            if (success) {
                Swal.fire({ ...swalProps, icon: 'success', title: successTitle, iconColor: 'var(--success-green)' });
            } else { 
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        Swal.fire({ ...swalProps, icon: 'success', title: successTitle, iconColor: 'var(--success-green)' });
                    }).catch(errN => {
                        console.error('Error using navigator.clipboard: ', errN);
                        Swal.fire({ ...swalProps, icon: 'error', title: errorTitle, timer:2000, iconColor: 'var(--danger-red)' });
                    });
                } else { 
                     Swal.fire({ ...swalProps, icon: 'error', title: errorTitle, timer:2000, iconColor: 'var(--danger-red)' });
                }
            }
        }


        async function openItemModal(itemId, mediaType, backdropPath) {
            console.log(`openItemModal called for ID: ${itemId}, Type: ${mediaType}`);
            updatePageBackground(backdropPath); 

            currentOpenSwalRef = Swal.fire({
                title: 'Carregando Detalhes...',
                html: '<div class="loader mx-auto my-10" style="width: 40px; height: 40px; border-width: 4px;"></div>',
                showConfirmButton: false,
                showCloseButton: true,
                allowOutsideClick: false, 
                customClass: {
                    popup: 'swal2-popup swal-details-popup',
                    title: 'swal2-title',
                    htmlContainer: 'swal2-html-container',
                    closeButton: 'swal2-close'
                },
                willClose: () => {
                    console.log("SweetAlert willClose event for item modal.");
                    updatePageBackground(null); 
                    const iframe = document.getElementById('swal-details-iframe');
                    if (iframe) iframe.src = 'about:blank'; 
                    currentOpenSwalRef = null;

                    // Se o modal foi fechado e não há parâmetros na URL, volte para a visualização principal do catálogo
                    const urlParams = new URLSearchParams(window.location.search);
                    if (!urlParams.has('type') || !urlParams.has('id')) {
                        console.log("Modal fechado, carregando conteúdo principal da página.");
                        // Apenas recarregue o conteúdo principal se não estivermos mais em um "deep link"
                        // Isso evita que, ao fechar um modal de um deep link, a página tente recarregar o catálogo por cima.
                        // A melhor abordagem para deep links é que fechar o modal "limpe" a URL ou redirecione.
                        // Por simplicidade aqui, vamos apenas garantir que o catálogo não apareça se foi um deep link.
                        if (defaultContentSections.style.display === 'none' && singleResultsSection.style.display === 'none') {
                           // Se estávamos em modo "página dedicada" (deep link), não faz nada aqui,
                           // a página permanecerá "vazia" com o fundo. O usuário pode navegar de volta ou pesquisar.
                           // Ou, poderíamos redirecionar para a página principal:
                           // window.history.pushState({}, '', window.location.pathname); // Limpa query params
                           // loadMainPageContent();
                        }
                    } else {
                        // Se fechou um modal de um deep link, a página deve ficar "vazia"
                        // ou redirecionar para a home.
                        // Para manter simples, vamos deixar a página "vazia".
                        // Poderíamos limpar a URL aqui para que um refresh carregue o catálogo:
                        // window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            });

            const details = await getItemDetails(itemId, mediaType);

            if (!Swal.isVisible() || !currentOpenSwalRef) { 
                updatePageBackground(null); 
                return;
            }

            if (!details || details.error) {
                Swal.update({
                    title: 'Erro',
                    html: `<p class="text-red-400 text-center py-10">Não foi possível carregar os detalhes. ${details?.message || 'Tente novamente.'}</p>`,
                    showConfirmButton: true,
                    confirmButtonText: 'Fechar',
                });
                return;
            }
            
            if (!backdropPath && details.backdrop_path) {
                updatePageBackground(details.backdrop_path);
            }

            const imdbId = details.external_ids?.imdb_id;
            let playerUrl = ''; 
            const linkForContentPage = `${window.location.origin}${window.location.pathname}?type=${mediaType}&id=${itemId}`;

            if (imdbId) {
                playerUrl = mediaType === 'movie' ? `${PLAYER_BASE_URL_MOVIE}${imdbId}` : `${PLAYER_BASE_URL_SERIES}${imdbId}`;
            }

            const title = details.title || details.name;
            const overview = details.overview || 'Sinopse não disponível.';
            const posterModalPath = details.poster_path ? `${TMDB_IMAGE_BASE_URL}w780${details.poster_path}` : `https://placehold.co/780x1170/0A0514/F0F0F0?text=Indispon%C3%ADvel&font=inter`;
            const releaseDate = details.release_date || details.first_air_date;
            const rating = details.vote_average ? details.vote_average.toFixed(1) : 'N/A';
            const genres = details.genres.map(g => g.name).join(', ');
            const runtime = details.runtime || (details.episode_run_time && details.episode_run_time.length > 0 ? details.episode_run_time[0] : null);

            const iframeContainerClass = mediaType === 'tv' ? 'iframe-series-dimensions' : '';

            let castSectionHTML = '';
            if (details.credits && details.credits.cast && details.credits.cast.length > 0) {
                const castMembers = details.credits.cast.slice(0, 15); 
                castSectionHTML = `
                    <div class="details-cast-section">
                        <h3 class="details-section-subtitle">Elenco Principal</h3>
                        <div class="details-cast-scroller">
                            ${castMembers.map(person => `
                                <div class="cast-member-card">
                                    <img src="${person.profile_path ? TMDB_IMAGE_BASE_URL + 'w185' + person.profile_path : PLACEHOLDER_PERSON_IMAGE}"
                                         alt="${person.name}" class="cast-member-photo"
                                         onerror="this.src='${PLACEHOLDER_PERSON_IMAGE}'; this.onerror=null;">
                                    <p class="cast-member-name">${person.name || 'Nome não disponível'}</p>
                                    <p class="cast-member-character">${person.character || ''}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            }

            let playerSectionHTML = '';
            if (playerUrl) {
                playerSectionHTML = `
                    <div class="details-player-section">
                        <h3 class="details-section-subtitle">Assistir Agora</h3>
                        <div class="details-iframe-container ${iframeContainerClass}">
                           <iframe id="swal-details-iframe" src="${playerUrl}" allowfullscreen title="Player de ${title}"></iframe>
                        </div>
                    </div>`;
            } else {
                playerSectionHTML = `<div class="details-player-section"><p class="details-player-unavailable">Player não disponível para este título.</p></div>`;
            }

            const detailsHTML = `
                <div class="swal-details-content">
                    <div class="details-flex-container">
                        <img src="${posterModalPath}" alt="Pôster de ${title}" class="details-poster" onerror="this.src='https://placehold.co/780x1170/0A0514/F0F0F0?text=Erro+Imagem&font=inter'; this.onerror=null;">
                        <div class="details-info-area">
                            <h2 class="details-content-title">${title}</h2>
                            <div class="details-meta-info">
                                ${releaseDate ? `<span><i class="fas fa-calendar-alt"></i>${new Date(releaseDate).toLocaleDateString('pt-BR')}</span>` : ''}
                                ${rating !== 'N/A' ? `<span><i class="fas fa-star"></i>${rating} / 10</span>` : ''}
                                ${runtime ? `<span><i class="fas fa-clock"></i>${runtime} min</span>` : ''}
                            </div>
                            ${genres ? `<p class="details-genres"><strong>Gêneros:</strong> ${genres}</p>` : ''}
                            <h3 class="details-section-subtitle">Sinopse</h3>
                            <p class="details-overview">${overview}</p>
                            <div class="details-actions">
                                <button id="copyLinkButtonModal" class="copy-link-button">
                                    <i class="fas fa-link"></i> Copiar Link da Página
                                </button>
                            </div>
                        </div>
                    </div>
                    ${castSectionHTML}
                    ${playerSectionHTML}
                </div>
            `;

            Swal.update({
                title: '', 
                html: detailsHTML,
                showConfirmButton: false,
                showCloseButton: true,
                allowOutsideClick: true, 
                didOpen: () => {
                    const copyButton = document.getElementById('copyLinkButtonModal');
                    if (copyButton) {
                        copyButton.addEventListener('click', () => copyToClipboard(linkForContentPage, true)); 
                    }
                }
            });
        }

        // --- Event Listeners ---
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(searchInput.value);
            }, 500); 
        });
        searchButton.addEventListener('click', () => {
            clearTimeout(searchTimeout); 
            performSearch(searchInput.value);
        });

        filterToggleButton.addEventListener('click', openFilterSweetAlert);

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (Swal.isVisible()) {
                    Swal.close();
                }
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOMContentLoaded event fired.");
            const urlParams = new URLSearchParams(window.location.search);
            const typeParam = urlParams.get('type');
            const idParam = urlParams.get('id');

            const apiKeyIsValid = TMDB_API_KEY && TMDB_API_KEY !== 'SUA_CHAVE_API_DO_TMDB_AQUI' && TMDB_API_KEY.length > 10;

            if (!apiKeyIsValid) {
                 console.error("Chave da API TMDB inválida ou não configurada.");
                 const errorMsg = `<p class="text-center text-red-400 p-4 col-span-full">Chave da API TMDB inválida ou não configurada. Verifique a constante TMDB_API_KEY no script.</p>`;
                 if(moviesResultsGrid) moviesResultsGrid.innerHTML = errorMsg;
                 if(tvShowsResultsGrid) tvShowsResultsGrid.innerHTML = errorMsg;
                 if(searchInput) searchInput.disabled = true;
                 if(searchButton) searchButton.disabled = true;
                 if(filterToggleButton) filterToggleButton.disabled = true;
                 if(loader) loader.style.display = 'none';
                 
                 const header = document.querySelector('header');
                 const errorDiv = document.createElement('div');
                 errorDiv.innerHTML = `<div class="bg-red-700 text-white text-center p-3"><strong>ERRO DE CONFIGURAÇÃO:</strong> A chave da API TMDB é necessária. O aplicativo não funcionará corretamente.</div>`;
                 if(header && header.parentNode) header.parentNode.insertBefore(errorDiv, header.nextSibling);
                 return; 
            }

            if (typeParam && idParam) {
                // Cenário de Link Direto para um item específico
                console.log(`Link direto detectado: type=${typeParam}, id=${idParam}. Escondendo seções principais e abrindo modal.`);
                if(defaultContentSections) defaultContentSections.style.display = 'none';
                if(singleResultsSection) singleResultsSection.style.display = 'none';
                
                // Limpar grids para evitar flash de conteúdo antigo
                if(moviesResultsGrid) moviesResultsGrid.innerHTML = ''; 
                if(tvShowsResultsGrid) tvShowsResultsGrid.innerHTML = '';
                if(singleResultsGrid) singleResultsGrid.innerHTML = '';
                
                if(loader) loader.style.display = 'none'; 
                
                openItemModal(idParam, typeParam, null);
            } else {
                // Cenário de carregamento da página principal (catálogo)
                console.log("Nenhum link direto detectado. Carregando conteúdo principal da página.");
                loadMainPageContent(); 
            }
        });
    </script>
</body>
</html>

