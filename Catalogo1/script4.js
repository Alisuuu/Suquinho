window.App=window.App||{};App.ModalHandlers=App.ModalHandlers||{};App.ModalHandlers.fetchItemDetails=async(e,t)=>{App.UI.elements.loader&&App.UI.elements.loader.classList.remove('hidden');try{const s=await App.API.fetchItemDetailsFromApi(e,t);s&&await App.ModalHandlers.displayModal(s,t)}catch(e){App.UI.showToast('Erro ao carregar detalhes. Tente novamente.')}finally{App.UI.elements.loader&&App.UI.elements.loader.classList.add('hidden')}};App.ModalHandlers.displayModal=async(e,t)=>{const s=e.title||e.name,a=e.overview||'Sinopse não disponível.',r=e.release_date||e.first_air_date,i=e.vote_average?e.vote_average.toFixed(1):'N/A',o=e.poster_path?`${App.Constants.IMAGE_BASE_URL}${e.poster_path}`:`https://placehold.co/400x600/0a0a0a/581c87?text=Poster`;App.UI.state.currentItemModalPlayerUrl='';let n='',l='',d='';if('movie'===t){const c=await App.API.fetchSuperflixMovieStream(e.imdb_id);n=`<div class="player-section"><div class="flex justify-between items-center mb-2"><h4 class="text-xl font-semibold text-violet-200">Player</h4><button id="copyMainPlayerLinkBtn" class="action-button text-xs py-1 px-3 rounded-md" title="Copiar link do player">Copiar Link<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div><div id="EmbedderIframeContainer"></div></div>`,App.UI.elements.modalBody&&(App.UI.elements.modalBody.innerHTML=`<div class="flex flex-col md:flex-row gap-8"><div class="md:w-1/3 flex-shrink-0"><img src="${o}" alt="${s}" class="w-full rounded-xl shadow-lg" onerror="this.src='https://placehold.co/400x600/0a0a0a/581c87?text=Poster'; this.alt='Poster Indisponível';"></div><div class="md:w-2/3"><h2 class="text-3xl lg:text-4xl font-bold mb-3 text-violet-300">${s}</h2><p class="text-sm text-gray-400 mb-1"><strong>Tipo:</strong> ${'movie'===t?'Filme':'Série de TV'}</p><p class="text-sm text-gray-400 mb-1"><strong>Lançamento:</strong> ${r?new Date(r).toLocaleDateString('pt-BR'):'Não informado'}</p><p class="text-sm text-gray-400 mb-4"><strong>Avaliação:</strong> ${i} ⭐</p><h4 class="text-xl font-semibold mb-2 text-violet-200">Sinopse Padrão</h4><p class="text-gray-300 mb-6 text-sm leading-relaxed">${a}</p></div></div>${n}${l}${d}`),App.UI.setItemModalOpen(!0);const p=document.getElementById('copyMainPlayerLinkBtn');c?(App.UI.loadVideoPlayer(c,'EmbedderIframeContainer'),p&&(p.disabled=!1,p.addEventListener('click',()=>{const e=document.createElement('textarea');e.value=App.UI.state.currentItemModalPlayerUrl,document.body.appendChild(e),e.select();try{document.execCommand('copy'),App.UI.showToast('Link do player copiado!')}catch(t){App.UI.showToast('Falha ao copiar.'),console.error('Falha ao copiar:',t)}document.body.removeChild(e)}))):(document.getElementById('EmbedderIframeContainer')&&(document.getElementById('EmbedderIframeContainer').innerHTML='<p class="text-center text-gray-400 py-4">Player não disponível para este filme.</p>'),p&&(p.disabled=!0))}else if('tv'===t){d=`<div class="text-center mt-4"><button id="copySeriesPageLinkBtn" class="action-button" title="Copiar link da página da série">Copiar Link da Série<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="ml-2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div>`,l=`<div class="seasons-section"><h4 class="text-xl font-semibold text-violet-200 mb-3">Temporadas e Episódios</h4><div id="seasonsAccordion"></div></div>`,App.UI.elements.modalBody&&(App.UI.elements.modalBody.innerHTML=`<div class="flex flex-col md:flex-row gap-8"><div class="md:w-1/3 flex-shrink-0"><img src="${o}" alt="${s}" class="w-full rounded-xl shadow-lg" onerror="this.src='https://placehold.co/400x600/0a0a0a/581c87?text=Poster'; this.alt='Poster Indisponível';"></div><div class="md:w-2/3"><h2 class="text-3xl lg:text-4xl font-bold mb-3 text-violet-300">${s}</h2><p class="text-sm text-gray-400 mb-1"><strong>Tipo:</strong> ${'movie'===t?'Filme':'Série de TV'}</p><p class="text-sm text-gray-400 mb-1"><strong>Lançamento:</strong> ${r?new Date(r).toLocaleDateString('pt-BR'):'Não informado'}</p><p class="text-sm text-gray-400 mb-4"><strong>Avaliação:</strong> ${i} ⭐</p><h4 class="text-xl font-semibold mb-2 text-violet-200">Sinopse Padrão</h4><p class="text-gray-300 mb-6 text-sm leading-relaxed">${a}</p></div></div>${n}${l}${d}`),App.UI.setItemModalOpen(!0);const u=document.getElementById('seasonsAccordion');e.seasons&&u&&e.seasons.filter(e=>e.season_number>0&&e.episode_count>0).forEach(async(s,a)=>{const r=document.createElement('div'),i=document.createElement('button');i.className='season-button',i.innerHTML=`${s.name||`Temporada ${s.season_number}`} <span class="text-xs text-gray-400">(${s.episode_count} episódios)</span> <span class="text-violet-300 ml-auto text-xl">${0===a?'▾':'▸'}</span>`;const o=document.createElement('div');o.className='episode-list-container hidden pl-4',0===a&&(i.classList.add('active'),o.classList.remove('hidden'),await App.ModalHandlers.loadSeasonEpisodes(e.id,s.season_number,o,e.external_ids?.imdb_id)),i.addEventListener('click',async()=>{const t=i.classList.toggle('active');i.querySelector('span:last-child').innerHTML=t?'▾':'▸',o.classList.toggle('hidden'),t&&(o.innerHTML.includes('Carregando episódios...')||''===o.innerHTML)&&await App.ModalHandlers.loadSeasonEpisodes(e.id,s.season_number,o,e.external_ids?.imdb_id)}),r.appendChild(i),r.appendChild(o),u.appendChild(r)});const m=document.getElementById('copySeriesPageLinkBtn');m&&m.addEventListener('click',()=>{const s=`${window.location.origin}${window.location.pathname}?type=${t}&id=${e.id}`,a=document.createElement('textarea');a.value=s,document.body.appendChild(a),a.select();try{document.execCommand('copy'),App.UI.showToast('Link da série copiado!')}catch(e){App.UI.showToast('Falha ao copiar.'),console.error('Falha ao copiar link da série:',e)}document.body.removeChild(a)})}};App.ModalHandlers.loadSeasonEpisodes=async(e,t,s,a)=>{s.innerHTML='<p class="text-sm text-gray-400 p-2">Carregando episódios...</p>';try{const r=await App.API.fetchSeasonDetailsFromApi(e,t);if(r&&r.episodes){if(s.innerHTML='',0===r.episodes.length)return void(s.innerHTML='<p class="text-sm text-gray-400 p-2">Nenhum episódio encontrado para esta temporada.</p>');r.episodes.forEach(e=>{const r=document.createElement('button');r.className='episode-button',r.textContent=`EP ${e.episode_number}: ${e.name||'Episódio sem título'}`,r.addEventListener('click',()=>App.ModalHandlers.openEpisodePlayerModal(a,t,e.episode_number,e.id,`S${t} E${e.episode_number}: ${e.name||'Episódio'}`)),s.appendChild(r)})}else s.innerHTML='<p class="text-sm text-red-400 p-2">Falha ao carregar episódios.</p>'}catch(e){console.error(`Erro ao carregar episódios da temporada ${t}:`,e),s.innerHTML='<p class="text-sm text-red-400 p-2">Falha ao carregar episódios.</p>',App.UI.showToast(`Erro ao carregar episódios da temporada ${t}.`)}
};App.ModalHandlers.openEpisodePlayerModal=async(e,t,s,a,r)=>{if(!e)return void App.UI.showToast('ID da série não encontrado para o player.');App.UI.elements.episodePlayerTitleEl&&(App.UI.elements.episodePlayerTitleEl.textContent=r||`Temporada ${t}, Episódio ${s}`);const i=document.getElementById('EpisodeEmbedderIframeContainer');if(!i)return;const o=document.createElement('div');o.id='tempEpisodeMessage',o.className='text-gray-400 mb-2 text-center',i.innerHTML='',i.appendChild(o),o.textContent='Verificando disponibilidade do episódio...',App.UI.state.currentEpisodePlayerUrl='',App.UI.elements.copyEpisodeLinkBtn&&(App.UI.elements.copyEpisodeLinkBtn.disabled=!0),App.UI.setEpisodeModalOpen(!0);try{const r=await App.API.fetchSuperflixEpisodeStream(a,t,s);r?(App.UI.loadVideoPlayer(r,'EpisodeEmbedderIframeContainer'),App.UI.elements.copyEpisodeLinkBtn&& (App.UI.elements.copyEpisodeLinkBtn.disabled=!1)):(i.innerHTML='<p class="text-center text-gray-400 py-4">Episódio não disponível no Superflix.</p>',App.UI.elements.copyEpisodeLinkBtn&& (App.UI.elements.copyEpisodeLinkBtn.disabled=!0))}catch(r){console.error(`Erro ao carregar player do episódio ${s} da temporada ${t}:`,r),i.innerHTML=`<p class="text-center text-gray-400 py-4">Falha ao carregar player (Erro: ${r.message}).</p>`,App.UI.elements.copyEpisodeLinkBtn&& (App.UI.elements.copyEpisodeLinkBtn.disabled=!App.UI.state.currentEpisodePlayerUrl)}};App.ModalHandlers.openChannelPlayerModal=async e=>{App.UI.elements.episodePlayerTitleEl&&(App.UI.elements.episodePlayerTitleEl.textContent=e.channel_name||'Canal de TV');const t=document.getElementById('EpisodeEmbedderIframeContainer');if(!t)return;const s=document.createElement('div');s.id='tempChannelMessage',s.className='text-gray-400 mb-2 text-center',t.innerHTML='',t.appendChild(s),s.textContent='Carregando canal...';const a=App.UI.elements.copyEpisodeLinkBtn;a&&(a.disabled=!0),App.UI.setEpisodeModalOpen(!0);try{const s=e.stream_url;s?(App.UI.loadVideoPlayer(s,'EpisodeEmbedderIframeContainer'),a&& (a.disabled=!1,App.UI.state.currentEpisodePlayerUrl=s)):(t.innerHTML='<p class="text-center text-gray-400 py-4">Stream do canal não disponível.</p>',a&& (a.disabled=!0))}catch(e){console.error('Erro ao carregar canal de TV:',e),t.innerHTML=`<p class="text-center text-gray-400 py-4">Falha ao carregar canal (Erro: ${e.message}).</p>`,a&& (a.disabled=!App.UI.state.currentEpisodePlayerUrl)}};
