<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Atualizações - Suquinho</title>
    
    
    <link href="../assets/fonts/roboto-flex.css" rel="stylesheet">
    <link href="../assets/fonts/material-symbols-outlined.css" rel="stylesheet" />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- Folhas de Estilo - Carregamento Dinâmico -->
    <script>
      const loadThemeCss = () => {
          const selectedTheme = localStorage.getItem('selectedTheme') || 'dracula'; // 'dracula' as fallback
          const cssFiles = [
              'update.css'
          ];

          // Remove existing theme stylesheets to prevent duplicates on theme change
          document.querySelectorAll('link[data-theme-css]').forEach(link => link.remove());

          cssFiles.forEach(file => {
              const link = document.createElement('link');
              link.rel = 'stylesheet';
              link.href = `../themes/${selectedTheme}/${file}`; // Adjusted path
              link.setAttribute('data-theme-css', ''); // Mark as theme CSS
              document.head.appendChild(link);
          });
      };

      // Load theme immediately
      loadThemeCss();
    </script>
    <style>
      body {
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
      }
      .changelog-container, .history-container {
        margin-top: 20px;
        padding: 15px;
        background-color: rgba(0,0,0,0.2);
        border-radius: 10px;
      }
      .changelog-content, .history-list {
        margin-top: 10px;
      }
      .history-list li {
        list-style-type: none;
        padding: 5px 0;
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }
    .history-button-container {
        margin-top: 20px;
        text-align: center;
      }
    </style>
</head>
<body>

    <div class="card-container">
        <div class="header">
            <h1 class="app-title">Suquinho</h1>
            <p class="repo-subtitle">Repositório: Alisuuu/Suquinho</p>
        </div>

        <div class="status-content">
            <div id="status-icon">
                <span class="material-symbols-outlined">sync</span>
            </div>
            <h2 id="status-text">Verificando...</h2>
            <p id="version-info"></p>
        </div>

        <div id="download-container">
        </div>
        
        <div id="changelog-container" class="changelog-container">
            <h3>Última Atualização</h3>
            <div id="changelog-content" class="changelog-content"></div>
        </div>

        

        
    </div>

    <script>
        const owner = 'Alisuuu';
        const repo = 'Suquinho';
        const apiUrl = `https://api.github.com/repos/${owner}/${repo}/releases`;
        const localStorageKey = `lastSeenVersion_${repo}`;

        const statusIcon = document.getElementById('status-icon');
        const statusText = document.getElementById('status-text');
        const versionInfo = document.getElementById('version-info');
        
        const downloadContainer = document.getElementById('download-container');
        const changelogContent = document.getElementById('changelog-content');

        function setLoadingState(isLoading) {
            if (isLoading) {
                statusText.textContent = 'Verificando...';
                versionInfo.textContent = '';
                statusIcon.className = 'icon-loading';
                statusIcon.innerHTML = '<span class="material-symbols-outlined">sync</span>';
                downloadContainer.innerHTML = '';
                changelogContent.innerHTML = '';
            } else {
                statusIcon.classList.remove('icon-loading');
            }
        }

        async function checkForUpdates() {
            setLoadingState(true);

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`API retornou ${response.status}`);
                
                const releases = await response.json();
                if (releases.length === 0) {
                    statusIcon.innerHTML = '<span class="material-symbols-outlined">cloud_off</span>';
                    statusText.textContent = 'Nenhuma versão';
                    versionInfo.textContent = 'Este repositório não tem releases.';
                    return;
                }

                const latestRelease = releases[0];
                const lastSeenVersion = localStorage.getItem(localStorageKey);

                if (latestRelease.tag_name !== lastSeenVersion) {
                    statusIcon.innerHTML = '<span class="material-symbols-outlined">sparkle</span>';
                    statusText.textContent = '';
                    localStorage.setItem(localStorageKey, latestRelease.tag_name);
                } else {
                    statusIcon.innerHTML = '<span class="material-symbols-outlined">verified</span>';
                    statusText.textContent = '';
                }
                
                const releaseDate = new Date(latestRelease.published_at).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                versionInfo.innerHTML = `Versão <strong>${latestRelease.tag_name}</strong> &bull; ${releaseDate}`;

                changelogContent.innerHTML = latestRelease.body.replace(/\n/g, '<br>');

                if (latestRelease.assets && latestRelease.assets.length > 0) {
                    const firstAsset = latestRelease.assets[0];
                    downloadContainer.innerHTML = `
                        <a href="${firstAsset.browser_download_url}" class="download-button" target="_blank">
                            <span class="material-symbols-outlined">download</span>
                            Baixar: ${firstAsset.name}
                        </a>
                    `;
                }

            } catch (error) {
                console.error('Falha ao buscar atualizações:', error);
                statusIcon.innerHTML = '<span class="material-symbols-outlined">wifi_off</span>';
                statusText.textContent = 'Erro de Conexão';
                versionInfo.innerHTML = 'Não foi possível buscar atualizações. <br>Verifique sua conexão e tente novamente.';
            } finally {
                setLoadingState(false);
            }
        }

        document.addEventListener('DOMContentLoaded', checkForUpdates);
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        document.body.style.visibility = 'visible';
        document.body.style.opacity = '1';
      });
    </script>
    <script src="../assets/sweetalert2/sweetalert2.min.js"></script>
</body>
</html>
